name: CMake

on:
  create:
    tags: [ "*" ]

env:
  OS_VERSION: "bullseye"
  TAG_NAME: ${GITHUB_REF/refs\/tags\//}

jobs:
  build:
    name: Build, package and deploy
    runs-on: self-hosted, bullseye
    strategy:
      matrix:
        cpu: [generic]
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis
          ref: '${{ env.OS_VERSION }}'
      - name: install dependencies
        run: |
          sudo apt update
          sudo apt install -y git-buildpackage
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v5
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
      - name: Generate and commit changelog
        run: |
          git merge main
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git config user.name "$GITHUB_ACTOR"
          gbp dch --debian-branch=bullseye --upstream-branch=main --new-version=${{ env.TAG_NAME }}-${{ github.run_id }}~${{ env.OS_VERSION }} --git-author --distribution=unstable --commit
          git push origin
          gbp buildpackage --git-ignore-new --git-upstream-tag=${{ env.TAG_NAME }} --git-keyid=A5A70917
