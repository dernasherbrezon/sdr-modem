#include <stdlib.h>
#include <stdio.h>
#include <check.h>
#include <complex.h>
#include "../src/dsp/frequency_modulator.h"
#include "utils.h"

frequency_modulator *mod = NULL;
float *float_input = NULL;

START_TEST (test_normal) {
    int code = frequency_modulator_create(1.2F, 1000, &mod);
    ck_assert_int_eq(code, 0);

    setup_input_data(&float_input, 0, 200);

    float complex *output = NULL;
    size_t output_len = 0;
    frequency_modulator_process(float_input, 200, &output, &output_len, mod);

    const float expected[] = {1.000000F, 0.000000F, 0.362358F, 0.932039F, -0.896758F, -0.442521F, 0.608351F, 0.793668F, 0.843854F, -0.536573F, 0.660317F, -0.750987F, 0.997739F, 0.067209F, -0.575552F, 0.817765F, 0.709299F, -0.704907F, -0.829308F, -0.558792F, -0.999647F, -0.026551F, -0.789881F,
                              -0.613259F, 0.797425F, -0.603419F, -0.727760F, 0.685832F, 0.943984F, 0.329991F, 0.871147F, -0.491022F, 0.986774F, -0.162103F, 0.182142F, 0.983272F, -0.543253F, -0.839569F, -0.232403F, 0.972620F, 0.782203F, 0.623024F, 0.738564F, 0.674184F, -0.422603F, 0.906315F,
                              -0.235772F, -0.971808F, -0.283691F, 0.958916F, 0.903679F, 0.428210F, 0.974437F, 0.224662F, 0.352398F, 0.935850F, -0.968128F, -0.250456F, 0.879674F, 0.475577F, 0.359101F, -0.933299F, -0.131414F, -0.991328F, 0.538888F, -0.842377F, 0.622249F, 0.782820F, -0.653598F,
                              -0.756842F, -0.432232F, 0.901762F, 0.329070F, 0.944306F, -0.082316F, 0.996606F, -0.991654F, -0.128931F, 0.981123F, -0.193385F, -0.776629F, -0.629958F, -0.927162F, 0.374662F, -0.969038F, 0.246910F, -0.466910F, -0.884305F, 0.887927F, 0.459984F, -0.479333F, -0.877633F,
                              -0.961657F, 0.274255F, -0.910437F, 0.413649F, -0.811051F, -0.584975F, 0.964998F, -0.262258F, -0.999015F, -0.044363F, 0.016727F, 0.999860F, 0.433665F, 0.901074F, -0.314155F, 0.949372F, -0.753803F, -0.657100F, 0.736091F, 0.676883F, 0.388708F, -0.921361F, -0.310563F,
                              -0.950553F, 0.168347F, -0.985728F, 0.960120F, 0.279589F, -0.999643F, -0.026732F, 0.565254F, 0.824917F, 0.999601F, -0.028262F, 0.984968F, 0.172737F, -0.004637F, 0.999989F, -0.509996F, -0.860177F, -0.124630F, 0.992203F, 0.915421F, 0.402499F, 0.945088F, 0.326817F,
                              0.118941F, 0.992901F, -0.808868F, -0.587990F, 0.535648F, 0.844441F, 0.847695F, -0.530483F, 0.602898F, -0.797818F, 0.996112F, -0.088098F, -0.367572F, 0.929995F, 0.453030F, -0.891495F, -0.981418F, -0.191882F, -0.898436F, 0.439105F, -0.995234F, -0.097512F, 0.275482F,
                              -0.961306F, -0.089550F, 0.995982F, 0.891298F, -0.453418F, 0.168284F, -0.985739F, 0.424064F, -0.905632F, 0.944026F, 0.329871F, -0.990740F, 0.135774F, 0.830300F, 0.557316F, 0.812188F, -0.583395F, 0.803736F, -0.594986F, 0.853255F, 0.521494F, -0.978663F, 0.205472F,
                              0.971997F, 0.234995F, 0.305794F, -0.952098F, 0.013241F, -0.999912F, 0.793114F, -0.609073F, 0.122519F, 0.992466F, 0.038138F, -0.999273F, -0.985333F, 0.170641F, -0.730190F, 0.683244F, -0.991206F, 0.132328F, 0.115900F, -0.993261F, 0.006050F, 0.999982F, 0.878127F,
                              -0.478427F, 0.206535F, -0.978439F, 0.517842F, -0.855476F, 0.872735F, 0.488194F, -0.994532F, -0.104432F, 0.622063F, 0.782967F, 0.969487F, -0.245141F, 0.981134F, -0.193331F, 0.489964F, 0.871742F, -0.932267F, -0.361770F, 0.635779F, 0.771871F, 0.853311F, -0.521402F,
                              0.711919F, -0.702262F, 0.981711F, 0.190380F, -0.710760F, 0.703434F, 0.851332F, -0.524628F, -0.640339F, -0.768093F, -0.934979F, -0.354702F, -0.497980F, -0.867188F, 0.979074F, -0.203504F, -0.966343F, 0.257256F, 0.633468F, 0.773769F, 0.996102F, 0.088207F, 0.881357F,
                              0.472451F, -0.501400F, 0.865215F, 0.185701F, -0.982606F, -0.866701F, 0.498828F, 0.031077F, 0.999517F, -0.089361F, 0.995999F, -0.987138F, 0.159869F, 0.709383F, -0.704823F, -0.979346F, 0.202191F, -0.004384F, 0.999990F, 0.157579F, 0.987506F, -0.770314F, 0.637665F,
                              -0.025465F, -0.999676F, -0.266660F, 0.963791F, 0.981102F, 0.193491F, 0.968643F, -0.248459F, 0.875996F, 0.482318F, -0.774617F, 0.632431F, 0.782280F, -0.622927F, -0.857747F, -0.514072F, -0.982180F, 0.187944F, -0.960464F, -0.278406F, 0.372553F, -0.928011F, -0.110555F,
                              0.993870F, 0.862404F, -0.506220F, 0.027818F, -0.999613F, 0.214167F, -0.976797F, 0.999479F, 0.032272F, -0.866881F, 0.498514F, 0.992303F, 0.123830F, 0.389033F, -0.921224F, 0.299733F, -0.954023F, 0.986853F, -0.161621F, -0.540571F, 0.841298F, 0.803984F, -0.594652F,
                              -0.600867F, -0.799349F, -0.853643F, -0.520859F, -0.200702F, -0.979652F, 0.969359F, 0.245650F, -0.946421F, -0.322935F, -0.036906F, 0.999319F, 0.584793F, 0.811183F, 0.086836F, 0.996223F, -0.996712F, -0.081021F, 0.992517F, -0.122107F, -0.642313F, -0.766442F, -0.997449F,
                              0.071380F, -0.983292F, -0.182033F, 0.067871F, -0.997694F, 0.406651F, 0.913584F, 0.289521F, -0.957172F, -0.804114F, -0.594475F, -0.820837F, -0.571163F, 0.208075F, -0.978113F, 0.531429F, 0.847103F, -0.130587F, -0.991437F, -0.997462F, 0.071200F, -0.927497F, 0.373831F,
                              -0.874613F, -0.484821F, 0.854131F, -0.520058F, -0.920757F, 0.390136F, 0.584500F, 0.811394F, 0.938867F, 0.344280F, 0.575499F, 0.817802F, -0.929153F, 0.369696F, 0.869934F, -0.493167F, -0.853360F, -0.521322F, -0.946092F, 0.323898F, -0.999976F, 0.006922F, -0.055546F,
                              -0.998456F, 0.458054F, 0.888924F, 0.300423F, -0.953806F, -0.755421F, -0.655240F, -0.728792F, -0.684735F};
    assert_complex_array(expected, 200, output, output_len);
}

END_TEST

void teardown() {
    if (mod != NULL) {
        frequency_modulator_destroy(mod);
        mod = NULL;
    }
    if (float_input != NULL) {
        free(float_input);
        float_input = NULL;
    }
}

void setup() {
    //do nothing
}

Suite *common_suite(void) {
    Suite *s;
    TCase *tc_core;

    s = suite_create("frequency_modulator");

    /* Core test case */
    tc_core = tcase_create("Core");

    tcase_add_test(tc_core, test_normal);

    tcase_add_checked_fixture(tc_core, setup, teardown);
    suite_add_tcase(s, tc_core);

    return s;
}

int main(void) {
    int number_failed;
    Suite *s;
    SRunner *sr;

    s = common_suite();
    sr = srunner_create(s);

    srunner_set_fork_status(sr, CK_NOFORK);
    srunner_run_all(sr, CK_NORMAL);
    number_failed = srunner_ntests_failed(sr);
    srunner_free(sr);
    return (number_failed == 0) ? EXIT_SUCCESS : EXIT_FAILURE;
}
