#include <stdlib.h>
#include <stdio.h>
#include <check.h>
#include "../src/dsp/lpf.h"

lpf *lpf_filter = NULL;
float *float_input = NULL;
float complex *complex_input = NULL;

void setup_input_data(float **input, size_t input_offset, size_t len) {
	float *result = malloc(sizeof(float) * len);
	ck_assert(result != NULL);
	for (size_t i = 0; i < len; i++) {
		// don't care about the loss of data
		result[i] = (float) (input_offset + i);
	}
	*input = result;
}

void setup_input_complex_data(float complex **input, size_t input_offset, size_t len) {
    float complex *result = malloc(sizeof(float complex) * len);
    ck_assert(result != NULL);
    for (size_t i = 0; i < len; i++) {
        // don't care about the loss of data
        result[i] = (float) (input_offset + i) + (float) (input_offset + i * 0.5f) * I;
    }
    *input = result;
}

void assert_float_array(const float expected[], size_t expected_size, float *actual, size_t actual_size) {
	ck_assert_int_eq(expected_size, actual_size);
	for (size_t i = 0; i < expected_size; i++) {
        ck_assert(fabsl(expected[i] - actual[i]) < 0.001);
	}
}

void assert_complex_array(const float expected[], size_t expected_size, float complex *actual, size_t actual_size) {
    ck_assert_int_eq(expected_size, actual_size);
    for (size_t i = 0, j = 0; i < expected_size * 2; i += 2, j++) {
        ck_assert(fabsl(expected[i] - crealf(actual[j])) < 0.001);
        ck_assert(fabsl(expected[i + 1] - cimagf(actual[j])) < 0.001);
    }
}

START_TEST (test_complex) {
    int code = lpf_create(1, 48000, 4800, 2000, 2000, sizeof(float complex), &lpf_filter);
    ck_assert_int_eq(code, 0);
    
    setup_input_complex_data(&complex_input, 0, 250);
    float complex *output = NULL;
    size_t output_len = 0;
    lpf_process(complex_input, 250, (void**) &output, &output_len, lpf_filter);

    const float expected[] = {0.000000F,0.000000F,-0.000866F,-0.000433F,-0.002663F,-0.001332F,-0.005120F,-0.002560F,-0.007577F,-0.003788F,-0.009053F,-0.004527F,-0.008546F,-0.004273F,-0.005553F,-0.002776F,-0.000644F,-0.000322F,0.004265F,0.002133F,0.006263F,0.003131F,0.002526F,0.001263F,-0.008132F,-0.004066F,-0.023914F,-0.011957F,-0.039697F,-0.019849F,-0.048253F,-0.024126F,-0.043013F,-0.021507F,-0.021544F,-0.010772F,0.011711F,0.005855F,0.044966F,0.022483F,0.061883F,0.030942F,0.047467F,0.023733F,-0.004426F,-0.002213F,-0.084415F,-0.042207F,-0.164403F,-0.082201F,-0.199681F,-0.099840F,-0.136507F,-0.068254F,0.076509F,0.038255F,0.476360F,0.238180F,1.076509F,0.538255F,1.863493F,0.931746F,2.800319F,1.400160F,3.835597F,1.917799F,4.915586F,2.457793F,5.995574F,2.997787F,7.047467F,3.523733F,8.061883F,4.030941F,9.044967F,4.522483F,10.011711F,5.005856F,10.978456F,5.489228F,11.956985F,5.978493F,12.951746F,6.475873F,13.960302F,6.980151F,14.976084F,7.488042F,15.991869F,7.995934F,17.002527F,8.501264F,18.006262F,9.003131F,19.004265F,9.502132F,19.999355F,9.999678F,20.994450F,10.497225F,21.991451F,10.995726F,22.990944F,11.495472F,23.992424F,11.996212F,24.994879F,12.497439F,25.997337F,12.998669F,26.999136F,13.499568F,28.000006F,14.000003F,29.000000F,14.500000F,30.000006F,15.000003F,31.000002F,15.500001F,32.000004F,16.000002F,33.000004F,16.500002F,33.999996F,16.999998F,35.000004F,17.500002F,36.000004F,18.000002F,37.000000F,18.500000F,38.000004F,19.000002F,38.999996F,19.499998F,39.999996F,19.999998F,41.000004F,20.500002F,41.999996F,20.999998F,43.000000F,21.500000F,43.999992F,21.999996F,44.999996F,22.499998F,46.000000F,23.000000F,47.000004F,23.500002F,48.000000F,24.000000F,49.000004F,24.500002F,50.000004F,25.000002F,51.000000F,25.500000F,52.000000F,26.000000F,53.000004F,26.500002F,54.000004F,27.000002F,55.000008F,27.500004F,56.000008F,28.000004F,57.000008F,28.500004F,58.000000F,29.000000F,59.000008F,29.500004F,60.000000F,30.000000F,60.999996F,30.499998F,62.000000F,31.000000F,63.000000F,31.500000F,63.999989F,31.999994F,65.000015F,32.500008F,65.999992F,32.999996F,67.000000F,33.500000F,68.000008F,34.000004F,69.000031F,34.500015F,69.999985F,34.999992F,71.000000F,35.500000F,71.999985F,35.999992F,73.000015F,36.500008F,73.999985F,36.999992F,75.000008F,37.500004F,76.000000F,38.000000F,77.000015F,38.500008F,78.000008F,39.000004F,79.000008F,39.500004F,80.000000F,40.000000F,81.000008F,40.500004F,82.000000F,41.000000F,82.999992F,41.499996F,83.999985F,41.999992F,85.000008F,42.500004F,86.000015F,43.000008F,87.000008F,43.500004F,88.000008F,44.000004F,89.000000F,44.500000F,90.000000F,45.000000F,91.000008F,45.500004F,92.000008F,46.000004F,93.000000F,46.500000F,94.000015F,47.000008F,95.000008F,47.500004F,96.000023F,48.000011F,97.000008F,48.500004F,98.000000F,49.000000F,98.999992F,49.499996F,100.000000F,50.000000F,101.000008F,50.500004F,102.000008F,51.000004F,103.000015F,51.500008F,104.000015F,52.000008F,104.999992F,52.499996F,105.999992F,52.999996F,106.999985F,53.499992F,108.000008F,54.000004F,109.000008F,54.500004F,110.000023F,55.000011F,111.000023F,55.500011F,112.000015F,56.000008F,112.999992F,56.499996F,114.000008F,57.000004F,114.999969F,57.499985F,116.000000F,58.000000F,117.000008F,58.500004F,118.000000F,59.000000F,119.000000F,59.500000F,120.000000F,60.000000F,121.000000F,60.500000F,121.999985F,60.999992F,123.000015F,61.500008F,124.000000F,62.000000F,124.999985F,62.499992F,126.000008F,63.000004F,127.000008F,63.500004F,128.000031F,64.000015F,128.999985F,64.499992F,130.000015F,65.000008F,131.000031F,65.500015F,131.999985F,65.999992F,132.999985F,66.499992F,133.999985F,66.999992F,134.999985F,67.499992F,136.000031F,68.000015F,136.999985F,68.499992F,137.999985F,68.999992F,139.000015F,69.500008F,140.000000F,70.000000F,141.000000F,70.500000F,142.000000F,71.000000F,143.000015F,71.500008F,144.000046F,72.000023F,144.999985F,72.499992F,145.999969F,72.999985F,147.000000F,73.500000F,148.000031F,74.000015F,149.000015F,74.500008F,150.000015F,75.000008F,151.000015F,75.500008F,152.000015F,76.000008F,153.000015F,76.500008F,154.000015F,77.000008F,154.999969F,77.499985F,156.000015F,78.000008F,157.000046F,78.500023F,157.999985F,78.999992F,159.000000F,79.500000F,160.000000F,80.000000F,161.000000F,80.500000F,162.000031F,81.000015F,162.999969F,81.499985F,164.000000F,82.000000F,164.999985F,82.499992F,166.000015F,83.000008F,167.000000F,83.500000F,168.000015F,84.000008F,168.999985F,84.499992F,170.000000F,85.000000F,171.000015F,85.500008F,172.000046F,86.000023F,173.000000F,86.500000F,174.000031F,87.000015F,175.000015F,87.500008F,176.000000F,88.000000F,176.999985F,88.499992F,177.999969F,88.999985F,179.000000F,89.500000F,180.000031F,90.000015F,181.000000F,90.500000F,182.000015F,91.000008F,183.000000F,91.500000F,184.000015F,92.000008F,185.000000F,92.500000F,185.999969F,92.999985F,187.000000F,93.500000F,187.999985F,93.999992F,189.000000F,94.500000F,190.000015F,95.000008F,191.000015F,95.500008F,192.000031F,96.000015F,192.999985F,96.499992F,194.000015F,97.000008F,194.999985F,97.499992F,196.000046F,98.000023F,197.000061F,98.500031F,198.000015F,99.000008F,198.999985F,99.499992F,200.000031F,100.000015F,200.999969F,100.499985F,201.999985F,100.999992F,202.999969F,101.499985F,204.000031F,102.000015F,205.000031F,102.500015F,206.000046F,103.000023F,207.000015F,103.500008F,208.000031F,104.000015F,209.000031F,104.500015F,210.000000F,105.000000F,210.999985F,105.499992F,211.999985F,105.999992F,213.000015F,106.500008F,214.000015F,107.000008F,215.000015F,107.500008F,216.000000F,108.000000F,217.000061F,108.500031F,217.999985F,108.999992F,219.000000F,109.500000F,220.000000F,110.000000F,220.999985F,110.499992F};
    assert_complex_array(expected, sizeof(expected) / sizeof(float) / 2, output, output_len);

    free(complex_input);
    setup_input_data(&complex_input, 250, 250);
    lpf_process(complex_input, 250, (void**) &output, &output_len, lpf_filter);
    const float expected2[] = {222.000015F,111.000008F,223.000000F,111.500000F,223.999969F,111.999985F,225.000000F,112.500000F,226.000046F,113.000023F,227.000031F,113.500015F,227.999954F,113.999977F,229.000015F,114.500008F,230.000015F,115.000008F,231.000015F,115.500008F,232.000000F,116.000000F,232.999985F,116.499992F,233.999985F,116.999992F,235.000015F,117.500008F,236.000015F,118.000008F,236.999969F,118.499985F,237.999985F,118.999992F,239.000015F,119.500008F,239.999985F,119.999992F,241.000015F,120.500008F,241.999985F,120.999992F,243.000046F,121.500023F,244.000031F,122.000015F,245.000015F,122.500008F,245.999954F,122.999977F,247.000031F,123.500015F,248.000015F,124.000008F,248.999969F,124.499985F,250.000046F,125.000023F,251.000015F,125.500008F,252.000061F,126.000031F,253.000000F,126.500000F,253.999969F,126.999985F,255.000031F,127.500015F,255.999954F,127.999977F,257.000000F,128.500000F,257.999969F,128.999985F,258.999939F,129.499969F,259.999939F,129.999969F,260.999908F,130.499954F,262.000031F,131.000015F,263.000000F,131.500000F,263.999939F,131.999969F,265.000000F,132.500000F,266.000000F,133.000000F,267.000031F,133.500015F,267.999939F,133.999969F,269.000000F,134.500000F,270.000031F,135.000015F,271.000092F,135.500046F,272.000031F,136.000015F,273.000000F,136.500000F,274.000031F,137.000015F,275.000031F,137.500015F,276.000031F,138.000015F,277.000000F,138.500000F,278.000000F,139.000000F,279.000031F,139.500015F,280.000061F,140.000031F,281.000031F,140.500015F,282.000031F,141.000015F,283.000031F,141.500015F,284.000000F,142.000000F,285.000031F,142.500015F,285.999969F,142.999985F,287.000000F,143.500000F,288.000031F,144.000015F,289.000000F,144.500000F,289.999969F,144.999985F,291.000031F,145.500015F,291.999939F,145.999969F,293.000031F,146.500015F,294.000000F,147.000000F,294.999969F,147.499985F,296.000031F,148.000015F,297.000031F,148.500015F,298.000061F,149.000031F,299.000061F,149.500031F,300.000000F,150.000000F,301.000061F,150.500031F,302.000031F,151.000015F,302.999969F,151.499985F,303.999939F,151.999969F,304.999939F,152.499969F,305.999939F,152.999969F,307.000031F,153.500015F,307.999939F,153.999969F,309.000031F,154.500015F,310.000031F,155.000015F,311.000092F,155.500046F,312.000031F,156.000015F,313.000031F,156.500015F,314.000000F,157.000000F,315.000061F,157.500031F,315.999969F,157.999985F,317.000031F,158.500015F,317.999878F,158.999939F,318.999969F,159.499985F,320.000000F,160.000000F,320.999969F,160.499985F,322.000000F,161.000000F,322.999969F,161.499985F,323.999939F,161.999969F,325.000031F,162.500015F,325.999969F,162.999985F,327.000061F,163.500031F,327.999969F,163.999985F,328.999969F,164.499985F,330.000000F,165.000000F,331.000061F,165.500031F,332.000031F,166.000015F,333.000031F,166.500015F,334.000000F,167.000000F,335.000000F,167.500000F,336.000000F,168.000000F,336.999969F,168.499985F,338.000061F,169.000031F,339.000000F,169.500000F,340.000031F,170.000015F,341.000031F,170.500015F,341.999969F,170.999985F,343.000061F,171.500031F,344.000031F,172.000015F,345.000031F,172.500015F,346.000000F,173.000000F,347.000000F,173.500000F,347.999969F,173.999985F,349.000000F,174.500000F,349.999908F,174.999954F,351.000000F,175.500000F,352.000000F,176.000000F,352.999939F,176.499969F,353.999969F,176.999985F,354.999908F,177.499954F,356.000061F,178.000031F,357.000031F,178.500015F,358.000000F,179.000000F,358.999939F,179.499969F,359.999939F,179.999969F,361.000031F,180.500015F,362.000000F,181.000000F,362.999969F,181.499985F,363.999908F,181.999954F,365.000000F,182.500000F,366.000000F,183.000000F,367.000031F,183.500015F,368.000092F,184.000046F,369.000000F,184.500000F,369.999969F,184.999985F,371.000061F,185.500031F,372.000061F,186.000031F,373.000061F,186.500031F,374.000031F,187.000015F,375.000000F,187.500000F,376.000000F,188.000000F,377.000061F,188.500031F,377.999908F,188.999954F,379.000061F,189.500031F,380.000061F,190.000031F,381.000031F,190.500015F,382.000031F,191.000015F,383.000000F,191.500000F,384.000061F,192.000031F,385.000122F,192.500061F,386.000000F,193.000000F,387.000000F,193.500000F,388.000000F,194.000000F,389.000000F,194.500000F,390.000031F,195.000015F,390.999939F,195.499969F,392.000031F,196.000015F,393.000000F,196.500000F,393.999908F,196.999954F,394.999969F,197.499985F,395.999969F,197.999985F,397.000031F,198.500015F,398.000061F,199.000031F,399.000000F,199.500000F,400.000000F,200.000000F,401.000000F,200.500000F,401.999969F,200.999985F,403.000061F,201.500031F,404.000031F,202.000015F,405.000031F,202.500015F,406.000031F,203.000015F,407.000000F,203.500000F,408.000061F,204.000031F,409.000000F,204.500000F,410.000000F,205.000000F,411.000000F,205.500000F,412.000000F,206.000000F,413.000061F,206.500031F,413.999939F,206.999969F,414.999969F,207.499985F,416.000000F,208.000000F,417.000000F,208.500000F,418.000031F,209.000015F,419.000031F,209.500015F,420.000000F,210.000000F,421.000122F,210.500061F,421.999969F,210.999985F,422.999969F,211.499985F,424.000000F,212.000000F,424.999969F,212.499985F,426.000000F,213.000000F,427.000031F,213.500015F,427.999969F,213.999985F,428.999969F,214.499985F,429.999969F,214.999985F,431.000000F,215.500000F,432.000031F,216.000015F,433.000031F,216.500015F,434.000031F,217.000015F,435.000092F,217.500046F,436.000000F,218.000000F,437.000061F,218.500031F,438.000031F,219.000015F,438.999969F,219.499985F,439.999969F,219.999985F,441.000031F,220.500015F,442.000031F,221.000015F,443.000000F,221.500000F,443.999969F,221.999985F,444.999969F,222.499985F,445.999939F,222.999969F,446.999969F,223.499985F,447.999939F,223.999969F,449.000000F,224.500000F,449.999969F,224.999985F,451.000000F,225.500000F,452.000031F,226.000015F,453.000000F,226.500000F,454.000000F,227.000000F,455.000031F,227.500015F,455.999908F,227.999954F,457.000000F,228.500000F,457.999969F,228.999985F,459.000031F,229.500015F,460.000000F,230.000000F,460.999939F,230.499969F,461.999939F,230.999969F,462.999939F,231.499969F,463.999878F,231.999939F,465.000061F,232.500031F,466.000031F,233.000015F,467.000061F,233.500031F,468.000092F,234.000046F,469.000092F,234.500046F,470.000031F,235.000015F,471.000092F,235.500046F};
    assert_complex_array(expected2, sizeof(expected2) / sizeof(float) / 2, output, output_len);
}
END_TEST

START_TEST (test_normal) {
	int code = lpf_create(2, 48000, 4800, 2000, 2000, sizeof(float), &lpf_filter);
	ck_assert_int_eq(code, 0);

	setup_input_data(&float_input, 0, 500);
	float *output = NULL;
	size_t output_len = 0;
	lpf_process(float_input, 500, (void**) &output, &output_len, lpf_filter);

	const float expected[] = { 0.000000F,-0.002663F,-0.007577F,-0.008546F,-0.000644F,0.006263F,-0.008132F,-0.039697F,-0.043013F,0.011711F,0.061883F,-0.004426F,-0.164403F,-0.136507F,0.476360F,1.863493F,3.835597F,5.995574F,8.061883F,10.011711F,11.956985F,13.960302F,15.991869F,18.006262F,19.999355F,21.991451F,23.992424F,25.997337F,28.000006F,30.000006F,32.000004F,33.999996F,36.000004F,38.000004F,39.999996F,41.999996F,43.999992F,46.000000F,48.000000F,50.000004F,52.000000F,54.000004F,56.000008F,58.000000F,60.000000F,62.000000F,63.999989F,65.999992F,68.000008F,69.999985F,71.999985F,73.999985F,76.000000F,78.000008F,80.000000F,82.000000F,83.999985F,86.000015F,88.000008F,90.000000F,92.000008F,94.000015F,96.000023F,98.000000F,100.000000F,102.000008F,104.000015F,105.999992F,108.000008F,110.000023F,112.000015F,114.000008F,116.000000F,118.000000F,120.000000F,121.999985F,124.000000F,126.000008F,128.000031F,130.000015F,131.999985F,133.999985F,136.000031F,137.999985F,140.000000F,142.000000F,144.000046F,145.999969F,148.000031F,150.000015F,152.000015F,154.000015F,156.000015F,157.999985F,160.000000F,162.000031F,164.000000F,166.000015F,168.000015F,170.000000F,172.000046F,174.000031F,176.000000F,177.999969F,180.000031F,182.000015F,184.000015F,185.999969F,187.999985F,190.000015F,192.000031F,194.000015F,196.000046F,198.000015F,200.000031F,201.999985F,204.000031F,206.000046F,208.000031F,210.000000F,211.999985F,214.000015F,216.000000F,217.999985F,220.000000F,222.000015F,223.999969F,226.000046F,227.999954F,230.000015F,232.000000F,233.999985F,236.000015F,237.999985F,239.999985F,241.999985F,244.000031F,245.999954F,248.000015F,250.000046F,252.000061F,253.999969F,255.999954F,257.999969F,259.999939F,262.000031F,263.999939F,266.000000F,267.999939F,270.000031F,272.000031F,274.000031F,276.000031F,278.000000F,280.000061F,282.000031F,284.000000F,285.999969F,288.000031F,289.999969F,291.999939F,294.000000F,296.000031F,298.000061F,300.000000F,302.000031F,303.999939F,305.999939F,307.999939F,310.000031F,312.000031F,314.000000F,315.999969F,317.999878F,320.000000F,322.000000F,323.999939F,325.999969F,327.999969F,330.000000F,332.000031F,334.000000F,336.000000F,338.000061F,340.000031F,341.999969F,344.000031F,346.000000F,347.999969F,349.999908F,352.000000F,353.999969F,356.000061F,358.000000F,359.999939F,362.000000F,363.999908F,366.000000F,368.000092F,369.999969F,372.000061F,374.000031F,376.000000F,377.999908F,380.000061F,382.000031F,384.000061F,386.000000F,388.000000F,390.000031F,392.000031F,393.999908F,395.999969F,398.000061F,400.000000F,401.999969F,404.000031F,406.000031F,408.000061F,410.000000F,412.000000F,413.999939F,416.000000F,418.000031F,420.000000F,421.999969F,424.000000F,426.000000F,427.999969F,429.999969F,432.000031F,434.000031F,436.000000F,438.000031F,439.999969F,442.000031F,443.999969F,445.999939F,447.999939F,449.999969F,452.000031F,454.000000F,455.999908F,457.999969F,460.000000F,461.999939F,463.999878F,466.000031F,468.000092F,470.000031F };
	assert_float_array(expected, sizeof(expected) / sizeof(float), output, output_len);

	free(float_input);
	setup_input_data(&float_input, 500, 500);
	lpf_process(float_input, 500, (void**) &output, &output_len, lpf_filter);
    const float expected2[] = {471.999969F,473.999969F,476.000061F,478.000092F,479.999969F,481.999969F,484.000061F,485.999969F,488.000061F,489.999939F,492.000000F,494.000031F,495.999969F,498.000000F,499.999908F,502.000092F,504.000092F,506.000061F,507.999878F,510.000031F,511.999878F,514.000061F,516.000061F,518.000000F,519.999878F,522.000061F,524.000122F,526.000000F,528.000000F,530.000061F,532.000122F,534.000061F,536.000061F,537.999878F,540.000000F,542.000122F,543.999939F,546.000000F,548.000000F,550.000000F,552.000000F,553.999878F,555.999939F,557.999939F,560.000061F,561.999939F,564.000122F,566.000061F,568.000000F,570.000122F,571.999939F,574.000061F,576.000000F,577.999878F,580.000000F,582.000061F,584.000061F,586.000000F,587.999939F,590.000000F,592.000122F,593.999939F,596.000061F,598.000000F,600.000061F,602.000000F,603.999878F,605.999939F,608.000000F,609.999878F,612.000061F,614.000000F,616.000061F,618.000244F,620.000061F,622.000122F,623.999939F,625.999939F,628.000122F,630.000000F,632.000061F,633.999939F,636.000000F,638.000061F,640.000000F,642.000000F,643.999878F,646.000122F,648.000061F,650.000122F,652.000061F,654.000122F,656.000061F,657.999939F,660.000000F,662.000122F,664.000183F,666.000000F,667.999939F,670.000061F,672.000061F,674.000000F,676.000122F,678.000061F,680.000183F,682.000122F,684.000000F,686.000000F,687.999939F,690.000061F,692.000000F,693.999878F,695.999878F,697.999878F,700.000000F,701.999939F,703.999939F,705.999878F,707.999939F,710.000061F,712.000122F,714.000000F,716.000000F,718.000061F,720.000122F,722.000000F,724.000061F,725.999817F,728.000122F,730.000061F,732.000061F,734.000000F,736.000000F,737.999939F,740.000061F,742.000061F,744.000061F,746.000122F,748.000122F,749.999878F,751.999939F,753.999878F,756.000000F,758.000061F,759.999878F,762.000061F,764.000061F,766.000000F,768.000061F,770.000000F,772.000000F,774.000000F,776.000061F,778.000000F,780.000061F,782.000000F,784.000183F,785.999939F,787.999939F,789.999878F,791.999939F,794.000122F,795.999939F,797.999878F,799.999939F,802.000061F,804.000000F,805.999817F,807.999939F,810.000122F,812.000183F,814.000122F,816.000122F,818.000000F,820.000305F,822.000000F,824.000000F,826.000000F,828.000000F,830.000061F,832.000061F,834.000061F,836.000061F,838.000000F,840.000000F,841.999939F,844.000061F,846.000061F,848.000122F,850.000061F,852.000061F,854.000122F,856.000000F,858.000122F,859.999939F,862.000061F,864.000122F,866.000000F,868.000061F,870.000000F,872.000061F,874.000122F,876.000000F,877.999878F,879.999939F,882.000061F,884.000061F,886.000061F,887.999939F,889.999939F,892.000000F,893.999939F,895.999878F,898.000061F,899.999878F,902.000000F,903.999939F,906.000000F,907.999939F,909.999878F,912.000000F,914.000122F,916.000000F,918.000000F,920.000122F,921.999878F,924.000122F,926.000061F,928.000061F,930.000061F,932.000000F,934.000061F,936.000000F,938.000000F,940.000122F,942.000000F,944.000122F,946.000000F,947.999939F,950.000061F,952.000122F,954.000000F,956.000000F,957.999878F,959.999878F,961.999939F,964.000061F,966.000183F,968.000000F,969.999878F};
    assert_float_array(expected2, sizeof(expected2) / sizeof(float), output, output_len);
}
END_TEST

void teardown() {
	if (lpf_filter != NULL) {
		lpf_destroy(lpf_filter);
        lpf_filter = NULL;
	}
	if( float_input != NULL ) {
		free(float_input);
        float_input = NULL;
	}
    if( complex_input != NULL ) {
        free(complex_input);
        complex_input = NULL;
    }
}

void setup() {
	//do nothing
}

Suite* common_suite(void) {
	Suite *s;
	TCase *tc_core;

	s = suite_create("lpf");

	/* Core test case */
	tc_core = tcase_create("Core");

	tcase_add_test(tc_core, test_normal);
    tcase_add_test(tc_core, test_complex);

	tcase_add_checked_fixture(tc_core, setup, teardown);
	suite_add_tcase(s, tc_core);

	return s;
}

int main(void) {
	int number_failed;
	Suite *s;
	SRunner *sr;

	s = common_suite();
	sr = srunner_create(s);

	srunner_set_fork_status(sr, CK_NOFORK);
	srunner_run_all(sr, CK_NORMAL);
	number_failed = srunner_ntests_failed(sr);
	srunner_free(sr);
	return (number_failed == 0) ? EXIT_SUCCESS : EXIT_FAILURE;
}
