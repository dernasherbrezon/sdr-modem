#include <stdlib.h>
#include <stdio.h>
#include <check.h>
#include "../src/dsp/lpf.h"

lpf *lpf_filter = NULL;
float *float_input = NULL;
float complex *complex_input = NULL;

void setup_input_data(float **input, size_t input_offset, size_t len) {
	float *result = malloc(sizeof(float) * len);
	ck_assert(result != NULL);
	for (size_t i = 0; i < len; i++) {
		// don't care about the loss of data
		result[i] = (float) (input_offset + i);
	}
	*input = result;
}

void setup_input_complex_data(float complex **input, size_t input_offset, size_t len) {
    float complex *result = malloc(sizeof(float complex) * len);
    ck_assert(result != NULL);
    for (size_t i = 0; i < len; i++) {
        // don't care about the loss of data
        result[i] = (float) (input_offset + i) + (float) (input_offset + i * 0.5f) * I;
    }
    *input = result;
}

void assert_float_array(const float expected[], size_t expected_size, float *actual, size_t actual_size) {
	ck_assert_int_eq(expected_size, actual_size);
	for (size_t i = 0; i < expected_size; i++) {
        ck_assert(fabsl(expected[i] - actual[i]) < 0.001);
	}
}

START_TEST (test_complex) {
    int code = lpf_create(1, 48000, 4800, 2000, 2000, sizeof(float complex), &lpf_filter);
    ck_assert_int_eq(code, 0);
    
    setup_input_complex_data(&complex_input, 0, 500);
    float *output = NULL;
    size_t output_len = 0;
    lpf_process(complex_input, 500, (void**) &output, &output_len, lpf_filter);
    //FIXME
}
END_TEST

START_TEST (test_normal) {
	int code = lpf_create(2, 48000, 4800, 2000, 2000, sizeof(float), &lpf_filter);
	ck_assert_int_eq(code, 0);

	setup_input_data(&float_input, 0, 500);
	float *output = NULL;
	size_t output_len = 0;
	lpf_process(float_input, 500, (void**) &output, &output_len, lpf_filter);

	const float expected[] = { 0.000000F,-0.002663F,-0.007577F,-0.008546F,-0.000644F,0.006263F,-0.008132F,-0.039697F,-0.043013F,0.011711F,0.061883F,-0.004426F,-0.164403F,-0.136507F,0.476360F,1.863493F,3.835597F,5.995574F,8.061883F,10.011711F,11.956985F,13.960302F,15.991869F,18.006262F,19.999355F,21.991451F,23.992424F,25.997337F,28.000006F,30.000006F,32.000004F,33.999996F,36.000004F,38.000004F,39.999996F,41.999996F,43.999992F,46.000000F,48.000000F,50.000004F,52.000000F,54.000004F,56.000008F,58.000000F,60.000000F,62.000000F,63.999989F,65.999992F,68.000008F,69.999985F,71.999985F,73.999985F,76.000000F,78.000008F,80.000000F,82.000000F,83.999985F,86.000015F,88.000008F,90.000000F,92.000008F,94.000015F,96.000023F,98.000000F,100.000000F,102.000008F,104.000015F,105.999992F,108.000008F,110.000023F,112.000015F,114.000008F,116.000000F,118.000000F,120.000000F,121.999985F,124.000000F,126.000008F,128.000031F,130.000015F,131.999985F,133.999985F,136.000031F,137.999985F,140.000000F,142.000000F,144.000046F,145.999969F,148.000031F,150.000015F,152.000015F,154.000015F,156.000015F,157.999985F,160.000000F,162.000031F,164.000000F,166.000015F,168.000015F,170.000000F,172.000046F,174.000031F,176.000000F,177.999969F,180.000031F,182.000015F,184.000015F,185.999969F,187.999985F,190.000015F,192.000031F,194.000015F,196.000046F,198.000015F,200.000031F,201.999985F,204.000031F,206.000046F,208.000031F,210.000000F,211.999985F,214.000015F,216.000000F,217.999985F,220.000000F,222.000015F,223.999969F,226.000046F,227.999954F,230.000015F,232.000000F,233.999985F,236.000015F,237.999985F,239.999985F,241.999985F,244.000031F,245.999954F,248.000015F,250.000046F,252.000061F,253.999969F,255.999954F,257.999969F,259.999939F,262.000031F,263.999939F,266.000000F,267.999939F,270.000031F,272.000031F,274.000031F,276.000031F,278.000000F,280.000061F,282.000031F,284.000000F,285.999969F,288.000031F,289.999969F,291.999939F,294.000000F,296.000031F,298.000061F,300.000000F,302.000031F,303.999939F,305.999939F,307.999939F,310.000031F,312.000031F,314.000000F,315.999969F,317.999878F,320.000000F,322.000000F,323.999939F,325.999969F,327.999969F,330.000000F,332.000031F,334.000000F,336.000000F,338.000061F,340.000031F,341.999969F,344.000031F,346.000000F,347.999969F,349.999908F,352.000000F,353.999969F,356.000061F,358.000000F,359.999939F,362.000000F,363.999908F,366.000000F,368.000092F,369.999969F,372.000061F,374.000031F,376.000000F,377.999908F,380.000061F,382.000031F,384.000061F,386.000000F,388.000000F,390.000031F,392.000031F,393.999908F,395.999969F,398.000061F,400.000000F,401.999969F,404.000031F,406.000031F,408.000061F,410.000000F,412.000000F,413.999939F,416.000000F,418.000031F,420.000000F,421.999969F,424.000000F,426.000000F,427.999969F,429.999969F,432.000031F,434.000031F,436.000000F,438.000031F,439.999969F,442.000031F,443.999969F,445.999939F,447.999939F,449.999969F,452.000031F,454.000000F,455.999908F,457.999969F,460.000000F,461.999939F,463.999878F,466.000031F,468.000092F,470.000031F };
	assert_float_array(expected, sizeof(expected) / sizeof(float), output, output_len);

	free(float_input);
	setup_input_data(&float_input, 500, 500);
	lpf_process(float_input, 500, (void**) &output, &output_len, lpf_filter);
    const float expected2[] = {471.999969F,473.999969F,476.000061F,478.000092F,479.999969F,481.999969F,484.000061F,485.999969F,488.000061F,489.999939F,492.000000F,494.000031F,495.999969F,498.000000F,499.999908F,502.000092F,504.000092F,506.000061F,507.999878F,510.000031F,511.999878F,514.000061F,516.000061F,518.000000F,519.999878F,522.000061F,524.000122F,526.000000F,528.000000F,530.000061F,532.000122F,534.000061F,536.000061F,537.999878F,540.000000F,542.000122F,543.999939F,546.000000F,548.000000F,550.000000F,552.000000F,553.999878F,555.999939F,557.999939F,560.000061F,561.999939F,564.000122F,566.000061F,568.000000F,570.000122F,571.999939F,574.000061F,576.000000F,577.999878F,580.000000F,582.000061F,584.000061F,586.000000F,587.999939F,590.000000F,592.000122F,593.999939F,596.000061F,598.000000F,600.000061F,602.000000F,603.999878F,605.999939F,608.000000F,609.999878F,612.000061F,614.000000F,616.000061F,618.000244F,620.000061F,622.000122F,623.999939F,625.999939F,628.000122F,630.000000F,632.000061F,633.999939F,636.000000F,638.000061F,640.000000F,642.000000F,643.999878F,646.000122F,648.000061F,650.000122F,652.000061F,654.000122F,656.000061F,657.999939F,660.000000F,662.000122F,664.000183F,666.000000F,667.999939F,670.000061F,672.000061F,674.000000F,676.000122F,678.000061F,680.000183F,682.000122F,684.000000F,686.000000F,687.999939F,690.000061F,692.000000F,693.999878F,695.999878F,697.999878F,700.000000F,701.999939F,703.999939F,705.999878F,707.999939F,710.000061F,712.000122F,714.000000F,716.000000F,718.000061F,720.000122F,722.000000F,724.000061F,725.999817F,728.000122F,730.000061F,732.000061F,734.000000F,736.000000F,737.999939F,740.000061F,742.000061F,744.000061F,746.000122F,748.000122F,749.999878F,751.999939F,753.999878F,756.000000F,758.000061F,759.999878F,762.000061F,764.000061F,766.000000F,768.000061F,770.000000F,772.000000F,774.000000F,776.000061F,778.000000F,780.000061F,782.000000F,784.000183F,785.999939F,787.999939F,789.999878F,791.999939F,794.000122F,795.999939F,797.999878F,799.999939F,802.000061F,804.000000F,805.999817F,807.999939F,810.000122F,812.000183F,814.000122F,816.000122F,818.000000F,820.000305F,822.000000F,824.000000F,826.000000F,828.000000F,830.000061F,832.000061F,834.000061F,836.000061F,838.000000F,840.000000F,841.999939F,844.000061F,846.000061F,848.000122F,850.000061F,852.000061F,854.000122F,856.000000F,858.000122F,859.999939F,862.000061F,864.000122F,866.000000F,868.000061F,870.000000F,872.000061F,874.000122F,876.000000F,877.999878F,879.999939F,882.000061F,884.000061F,886.000061F,887.999939F,889.999939F,892.000000F,893.999939F,895.999878F,898.000061F,899.999878F,902.000000F,903.999939F,906.000000F,907.999939F,909.999878F,912.000000F,914.000122F,916.000000F,918.000000F,920.000122F,921.999878F,924.000122F,926.000061F,928.000061F,930.000061F,932.000000F,934.000061F,936.000000F,938.000000F,940.000122F,942.000000F,944.000122F,946.000000F,947.999939F,950.000061F,952.000122F,954.000000F,956.000000F,957.999878F,959.999878F,961.999939F,964.000061F,966.000183F,968.000000F,969.999878F};
    assert_float_array(expected2, sizeof(expected2) / sizeof(float), output, output_len);
}
END_TEST

void teardown() {
	if (lpf_filter != NULL) {
		lpf_destroy(lpf_filter);
        lpf_filter = NULL;
	}
	if( float_input != NULL ) {
		free(float_input);
        float_input = NULL;
	}
    if( complex_input != NULL ) {
        free(complex_input);
        complex_input = NULL;
    }
}

void setup() {
	//do nothing
}

Suite* common_suite(void) {
	Suite *s;
	TCase *tc_core;

	s = suite_create("lpf");

	/* Core test case */
	tc_core = tcase_create("Core");

	tcase_add_test(tc_core, test_normal);
    tcase_add_test(tc_core, test_complex);

	tcase_add_checked_fixture(tc_core, setup, teardown);
	suite_add_tcase(s, tc_core);

	return s;
}

int main(void) {
	int number_failed;
	Suite *s;
	SRunner *sr;

	s = common_suite();
	sr = srunner_create(s);

	srunner_set_fork_status(sr, CK_NOFORK);
	srunner_run_all(sr, CK_NORMAL);
	number_failed = srunner_ntests_failed(sr);
	srunner_free(sr);
	return (number_failed == 0) ? EXIT_SUCCESS : EXIT_FAILURE;
}
